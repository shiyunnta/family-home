<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ğŸ  Family Home Tracker</title>
<style>
body { font-family: system-ui; background:#f3f4f6; margin:0; padding:20px;}
h1 { text-align:center; }
.card { background:white; border-radius:12px; padding:16px; margin-bottom:16px; box-shadow:0 2px 6px rgba(0,0,0,.1);}
.member { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;}
.home { color:green; font-weight:bold; }
.out { color:#999; }
input,button { padding:8px; border-radius:8px; border:1px solid #ccc;}
button { background:#2563eb; color:white; border:none; cursor:pointer;}
</style>
</head>

<body>
<h1>ğŸ  å®¶æ—åœ¨å®…ç®¡ç†</h1>

<div id="status" class="card">æ¥ç¶šä¸­â€¦</div>

<div class="card">
<h3>ğŸ  å®¶ã®ç™»éŒ²ï¼ˆIPã§è‡ªå‹•åˆ¤å®šï¼‰</h3>
<input id="homeName" placeholder="ä¾‹ï¼šè‡ªå®…">
<button onclick="addHome()">ã“ã®å ´æ‰€ã‚’å®¶ã¨ã—ã¦ç™»éŒ²</button>
<p id="ipInfo"></p>
</div>

<div class="card">
<h3>ğŸ‘¤ è‡ªåˆ†ã®åå‰</h3>
<input id="myName" placeholder="ã‚ãªãŸã®åå‰">
<button onclick="saveName()">ä¿å­˜</button>
</div>

<div class="card">
<h3>ğŸ“¡ ç¾åœ¨ã®çŠ¶æ…‹</h3>
<p id="myState"></p>
</div>

<div class="card">
<h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶æ—ã®åœ¨å®…çŠ¶æ³</h3>
<div id="members"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAhwHln5UO8x9hg0qeyk2TfeB_mhZROD90",
  authDomain: "home-79d04.firebaseapp.com",
  databaseURL: "https://home-79d04-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "home-79d04",
  storageBucket: "home-79d04.appspot.com",
  messagingSenderId: "86113064448",
  appId: "1:86113064448:web:0b5ab0f2cf6a1c9f6eaae5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const FAMILY_KEY = "pukumaru290";
const userId = localStorage.getItem("uid") || "u" + Date.now();
localStorage.setItem("uid", userId);

let myIP = "";
let homes = [];
let members = [];

async function getIP(){
  const r = await fetch("https://api.ipify.org?format=json");
  const j = await r.json();
  return j.ip;
}

myIP = await getIP();
document.getElementById("ipInfo").textContent = "ã‚ãªãŸã®IP: " + myIP;

onValue(ref(db,"homes"), snap=>{
  homes = [];
  snap.forEach(c=> homes.push({id:c.key,...c.val()}));
  detect();
});

onValue(ref(db,"members"), snap=>{
  members = [];
  snap.forEach(c=> members.push({id:c.key,...c.val()}));
  render();
});

window.addHome = function(){
  const name = homeName.value;
  if(!name) return alert("å®¶ã®åå‰ã‚’å…¥åŠ›");
  push(ref(db,"homes"),{
    familyKey:FAMILY_KEY,
    name,
    ipList:[myIP]
  });
}

window.saveName = function(){
  const name = myName.value;
  localStorage.setItem("name",name);
  detect();
}

function detect(){
  let home=null;
  for(const h of homes){
    if(h.ipList?.includes(myIP)) home=h;
  }

  const status = home ? "home":"out";
  const name = localStorage.getItem("name") || "æœªè¨­å®š";

  set(ref(db,"members/"+userId),{
    familyKey:FAMILY_KEY,
    name,
    status,
    home: home ? home.name : "",
    ip: myIP,
    last:Date.now()
  });

  myState.textContent = home ? "ğŸ  åœ¨å®…ä¸­":"ğŸš¶ å¤–å‡ºä¸­";
}

function render(){
  membersDiv.innerHTML="";
  members.forEach(m=>{
    if(m.familyKey!==FAMILY_KEY) return;
    const d=document.createElement("div");
    d.className="member";
    d.innerHTML=`<span>${m.name}</span><span class="${m.status}">${m.status==="home"?"ğŸ  åœ¨å®…":"å¤–å‡º"}</span>`;
    membersDiv.appendChild(d);
  });
  status.textContent="Firebaseæ¥ç¶šOK";
}
</script>
</body>
</html>
